<!-- {% extends 'base.html' %} -->

{% block title %}Arena{% endblock %}

{% block content %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
{% if user.is_authenticated and user_has_robot == True %}
  Hi {{ user.username }}!
  <p><a href="{% url 'logout' %}">logout</a></p>

{% else %}
<p>You are not authorized to access the arena.</p>
<a href="{% url 'home' %}">login</a>

{}
{% endif %}

<p>MQTT read:
<input type="text" name="bbb" id="bbb" />
</p>

<p>MQTT send:
<input type="text" name="send" id="send" />
</p>
<button type="button" onclick="foo()">Click Me!</button>

<script type"text/javascript" language="javascript">
  var msg = "k";
  var mqtt;
  var reconnectTimeout=2000;
  var host= "{{mqtthost}}";
  var port = {{mqttport}};//32285;

  //mqtt = new Paho.MQTT.Client("m21.cloudmqtt.com", 32285, "web_" + parseInt(Math.random() * 100, 10));
  mqtt = new Paho.MQTT.Client(host, port, "{{mqttuser}}");

  mqtt.onConnectionLost = onConnectionLost;
  mqtt.onMessageArrived = onMessageArrived;
  console.log("{{UUID}}");
  console.log("connecting to " + host + " "+ port);

  var options = {
    useSSL: true,
        userName: "{{mqttuser}}",
        password: "{{mqttpass}}",
    timeout: 3,
    onSuccess: onConnect,//callback function
    onFailure:doFail
  };

   // mqtt.connect(options);//Connect
 setTimeout(function(){ mqtt.connect(options); }, 20000);
  function onConnect(){
  //Once a connection has been made, make a subscription and send a message
  console.log("Connected");
  //mqtt.subscribe("users/robots/{{mqttuser}}");//subscribe to topic
  mqtt.subscribe("{{mqttuser}}");//subscribe to topic
  //var data = JSON.stringify({X: 0, Y: 6});
  message = new Paho.MQTT.Message(msg);
//  message.destinationName="users/robots/{{mqttuser}}"; //Publish topic = /test
message.destinationName="{{mqttuser}}"; //Publish topic = /test
  mqtt.send(message); //publish message
  }

  function doFail(e){
    console.log(e);
  }

  // called when the client loses its connection
  function onConnectionLost(responseObject) {
    if (responseObject.errorCode !== 0) {
      console.log("onConnectionLost:"+responseObject.errorMessage);
    }
  }

  // called when a message arrives
  function onMessageArrived(message) {
    check(message);
    console.log("onMessageArrived:"+message.payloadString);
    document.getElementById('bbb').value = message.payloadString;
  }

  function foo(){
    msg = document.getElementById('send').value;
    onConnect();
  }

  function check(message){
    if(message.payloadString == "hit"){
      console.log("Hit!");
    }

    else{
      console.log("Miss");
    }
  }
</script>


{% endblock %}
