<!-- {% extends 'base.html' %} -->

{% block title %}Arena{% endblock %}
{% load static %}
{% block content %}
<!-- <body style="background-color:#273c75;"> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>

{% if user.is_authenticated and user_has_robot == True %}

{% else %}
<p>You are not authorized to access the arena.</p>
<a href="{% url 'home' %}">login</a>

{% endif %}
<style>

@font-face {
    font-family: Iron;
    src: url({% static 'fonts/Arame-Regular.otf' %});

    }

    .top-tier{
      font-weight: 200;
      text-align: left;
      font-family: Iron;
      color: #34ace0;
      font-size: 1em;
      padding-top: 10px;
      padding-left: 30px;
    }

    .middle-tier{
      font-weight: 200;
      text-align: left;
      font-family: Iron;
      color: #dfe6e9;
      font-size: 1em;
      padding-top: 10px;
      padding-left: 30px;
    }

    .third-tier{
      font-weight: 200;
      text-align: left;
      font-family: Iron;
      color: #34ace0;
      font-size: 1em;
      padding-top: 10px;
      padding-left: 30px;
    }

.health{
  position: relative;
  display: block;
  height: 150px;
  width: 150px;

  background-image: url({% static 'bg4.png' %});
  background-size: 100% 100%;
  border-radius: 50%;
  font-weight: 200;
  /* border:1px solid #4bcffa; */
  /* display: inline-block;
  -moz-box-shadow:    inset 0 0 40px #4bcffa;
  -webkit-box-shadow: inset 0 0 40px #4bcffa;
  box-shadow:         inset 0 0 40px #4bcffa; */
  text-align: center;
  font-family: Iron;
  color: #dfe6e9;
  font-size: 2em;
  padding-top: 50px;
  padding-bottom: 50px;
  margin-left: 50px;
  margin-top: 50px;
}

.bottom-info{
  position: absolute;
  margin-bottom: 70px;
  margin-left: 50px;
  background-image: url({% static 'b3.png' %});
  background-size: 100% 100%;
  height:104px;
  width: 348px;
  right: 0;
  bottom: 0;
  left: 0;
}


</style>
<!-- Hi {{ user.username }}! -->
    <div style="box-shadow: 0px 0px 2500px #4bcffa inset;" class="vignette"></div>
        <img style="position: absolute; width: 100%; height: 100%; z-index: -1;" src="{{camera_ip}}">
        <div class="centered" style="color: #dfe6e9; font-family: Iron; font-size: 2.5em">+</div>
    </div>
<!-- Hi {{ user.username }}! -->

    <div class="fixed-top">
        <div class="container-fluid" style="height:100px; margin-top: 20px;">
          <div class="health" id="yourhealth">100%</div>
        </div>
        <!-- <p id="timer" style="margin-top:200px">Time Remaining in turn: </p>
        <p><a href="{% url 'logout' %}">logout</a></p> -->
    </div>

    <div class="bottom-info">
      <div class="top-tier">Time Remaining in Turn: </div>
      <div class="middle-tier" id="opponenthealth">Opponent Health:  </div>
      <div class="third-tier">Time Remaining in Game: </div>
    </div>

<script type"text/javascript" language="javascript">
  var robots = [];
  var yourhealth;
  var opponenthealth;
  var robotturn;
  var msg = "k";
  var mqtt;
  var host= "{{mqtthost}}";
  var port = {{mqttport}};//32285;

  console.log("connecting to " + host + " "+ port);
  setTimeout(function(){ connectclient(); }, 1000);

  //Connect to broker function
  function connectclient(){
    mqtt = new Paho.MQTT.Client(host, port, "{{mqttuser}}");

    mqtt.onConnectionLost = onConnectionLost;
    mqtt.onMessageArrived = onMessageArrived;

    var options = {
      useSSL: true,
          userName: "{{mqttuser}}",
          password: "{{mqttpass}}",
      timeout: 3,
      onSuccess: onConnect,//callback function
      onFailure: doFail
    };
    mqtt.connect(options);
  }

  //Called upon successful connection to broker
  function onConnect(){
  //Once a connection has been made, make a subscription and send a message
  console.log("Connected");
  mqtt.subscribe("health");//subscribe to topic
  message = new Paho.MQTT.Message(msg);
  message.destinationName="{{mqttuser}}"; //Publish topic = /test
  mqtt.send(message); //publish message
  }

  function doFail(e){
    //console.log(e);
    if(e.errorCode == 6){
      console.log("Awaiting password change procedure...")
    }

    else{
      console.log(e);
    }
    setTimeout(function(){ connectclient(); }, 1000);

  }

  // called when the client loses its connection
  function onConnectionLost(responseObject) {
    if (responseObject.errorCode !== 0) {
      console.log("onConnectionLost:"+responseObject.errorMessage);
    }
  }

  // called when a message arrives
  function onMessageArrived(message) {
    console.log("onMessageArrived:"+message.payloadString);
    //document.getElementById('health').value = message.payloadString;
    check(message);
  }

  function foo(){
    msg = document.getElementById('send').value;
    onConnect();
  }

  //Check message received from robot for JSON data
  function check(message){
    var myObj, i;
    try{
            myObj = JSON.parse(message.payloadString);

            //{"initialise": "robot1", "health": 100}
            //{"initialise":"robot1"}
            //NOT {"health: 100"}
            console.log("******************");
            //initialises robots in match

            //If JSON contains "initialise"
            if(myObj.initialise){
                //If the JSON initialises a robot that already exists
                    if( robots.includes(myObj.initialise) ){
                      console.log("Robot already initialised");
                    }
                    //If JSON initialises a robot name not yet in array and if the array has less than two elements, add to array.
                    if( robots.length< 2 && robots.includes(myObj.initialise) == false){
                      console.log("Robot not yet initialised. Adding.");
                      robots[robots.length] = myObj.initialise;
                    }

                    if(robots.length == 2){
                      console.log("Two robots already initialised.");
                      move();
                      // alert("Two players initialised. Beginning game.");
                      //   $.ajax({
                      //     method: "POST",
                      //     url: "http://127.0.0.1:8000/ajax/"+robots[0]+"/"+robots[1],
                      //     data: {csrfmiddlewaretoken: "{{ csrf_token }}",
                      //           "status" : "begingame"
                      //           // "robotturn": robots[0]
                      //           },
                      //     dataType: "json",
                      //     success: function(data){
                      //       console.log("Game On!")
                      //       // if (data.robotturn) {
                      //       //   console.log(data.robotturn);
                      //       //   robotturn = true;
                      //       //   //play();
                      //       // }
                      //     }
                      //   });
                    }
                    //Sends health of robots
                    if(myObj.health){
                        if(myObj.initialise == "{{mqttuser}}"){
                          yourhealth = myObj.health;
                          document.getElementById("yourhealth").innerHTML = yourhealth+"%";
                        }
                        else{
                          opponenthealth = myObj.health;
                          document.getElementById("opponenthealth").innerHTML = "Opponent Health: "+opponenthealth+"%";
                        }
                    }
                  console.log("Initialised robots= "+robots.toString());
                  console.log("Your robot is : "+"{{mqttuser}}");
                  console.log("Your health = "+yourhealth);
                  console.log("Your opponent health = "+opponenthealth);
                  console.log("******************")
            }

            // if(myObj.robotturn == "{{mqttuser}}"){
            //   robotturn = myObj.robotturn;
            //   play();
            // }

            if(myObj.gamestatus == "gameover"){
              window.location.replace("{% url 'home' %}");
              //Redirect HERE
            }
            else{
              console.log("Not recognised");
              console.log("******************")
            }
    }
    catch(e){
      console.log("Invalid Input");
    }
  }

  // function game(){
  //       //Call to django
  //       if(robotturn == "{{mqttuser}}"){
  //         $.ajax({
  //           method: "POST",
  //           url: "http://127.0.0.1:8000/roboapp/ajax/"+robots[0]+"/"+robots[1],
  //           data: {csrfmiddlewaretoken: "{{ csrf_token }}",
  //                 "status" : "begingame",
  //                 "robotturn": robots[0]
  //                 },
  //           dataType: "json",
  //           success: function(data){
  //             if (data.status) {
  //               console.log(data.status);
  //               play();
  //             }
  //           }
  //         });
  //       }
  //
  //       else{
  //         alert("Click here to begin your turn.")
  //       }
  // }

  // function play(){
  //   alert("Click to begin your game!");
  //   move();
  // }

  function move(){
    console.log("Move!");
    // var up = false,
    //     right = false,
    //     down = false,
    //     left = false,
    //     x = window.innerWidth/2-130/2,
    //     y = window.innerHeight/2-130/2
    document.addEventListener('keydown',press)
    function press(e){
      if (e.keyCode === 38 /* up */ || e.keyCode === 87 /* w */ || e.keyCode === 90 /* z */){
        up = true;
      }
      if (e.keyCode === 39 /* right */ || e.keyCode === 68 /* d */){
        right = true
      }
      if (e.keyCode === 40 /* down */ || e.keyCode === 83 /* s */){
        down = true
      }
      if (e.keyCode === 37 /* left */ || e.keyCode === 65 /* a */ || e.keyCode === 81 /* q */){
        left = true
      }
    }
    // document.addEventListener('keydown',press)
    // function press(e){
    document.addEventListener('keyup',release)
    function release(e){
      if (e.keyCode === 38 /* up */ || e.keyCode === 87 /* w */ || e.keyCode === 90 /* z */){
        up = false;
        console.log("up");
      }
      if (e.keyCode === 39 /* right */ || e.keyCode === 68 /* d */){
        right = false;
        console.log("right");
      }
      if (e.keyCode === 40 /* down */ || e.keyCode === 83 /* s */){
        down = false;
        console.log("down");
      }
      if (e.keyCode === 37 /* left */ || e.keyCode === 65 /* a */ || e.keyCode === 81 /* q */){
        left = false;
        console.log("left");
      }
    }
  }

  function starttimer() {
    var totaltime = arguments[0];
    var zeroFill = function(units) {
      return units < 10 ? "0" + units + "" : units;
    };
    var count = 0;

    var interval = window.setInterval(function() {
      var centisecondsRemaining = totaltime - count;
      var min = Math.floor(centisecondsRemaining / 100 / 60);
      var sec = zeroFill(Math.floor(centisecondsRemaining / 100 % 60));
      var cs = zeroFill(centisecondsRemaining % 100);
      //console.log(min + ":" + sec + ":" + cs);
      // document.getElementById("timer").innerHTML = "Turn Time Remaining: " + min + ":" + sec + ":" + cs;
      count++;
      if (centisecondsRemaining === 0) {
        clearInterval(interval);
        //game.endGame();
        //game.timesUp();
        game();
      }
      // if (game.state.questionsAnswered === game.state.numberOfQuestions) {
      //   clearInterval(interval);
      // }
      // if (game.state.questionsAnswered === game.state.numberOfQuestions) {
      //   clearInterval(interval);
      // }
    }, 10);
  }
</script>

{% endblock %}
